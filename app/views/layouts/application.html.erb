<!DOCTYPE html>
<html>
<head>
  <title>Healthfindergh</title>
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <%= csrf_meta_tags %>
</head>
<body>

<div class='container'>
	<header class='nav navbar'>
		<div id="current_user">
		<% if current_user %>
			<img id="profile_pic" src="<%= current_user.photo %>">
			Welcome <%= current_user.username %>
			<%= link_to "Sign Out", signout_path %>
		<% else %>
			<%= link_to "Sign in with Twitter", "/auth/twitter" %>
		<% end %>
		</div>
	</header>

<%= yield %>

</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
<script>

	var current_lat = 0;
	var current_long = 0;

	navigator.geolocation.getCurrentPosition(function(position){
		// current_lat = position.coords.latitude;
		// current_long = position.coords.longitude;
		current_lat = 5.53282;
		current_long = -0.2177;

	var map = L.map('map').setView([current_lat, current_long], 13);
console.log(current_lat);
console.log(current_long);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	    maxZoom: 18,
	    id: 'jamescorey82.cigwmmw8k0s9tvkm5oddb184s',
	    accessToken: 'pk.eyJ1IjoiamFtZXNjb3JleTgyIiwiYSI6ImNpZ3dtbXhmbjBzNnQ0bW0zeGYzNjVwdTAifQ.SES6Vh2bG_ltfmXzLkWBeg'
	}).addTo(map);

	$.ajax({
		method: "GET",
		url: "/facilities.json",
		dataType: "json"
	}).done(function(results){
			var low_lat = (current_lat - 0.15);
			console.log(low_lat);
			var high_lat = (current_lat + 0.15);
			console.log(high_lat);
			var low_long = (current_long - 0.15);
			var high_long = (current_long + 0.15);

		$.each(results, function(i, result){
			if (low_lat < result.latitude && result.latitude < high_lat && low_long < result.longitude && result.longitude < high_long) {
			// if (result.latitude < 6 && result.latitude > 5 && result.longitude > -0.7 && result.longitude < 0.3) {
				var marker = L.marker([result.latitude, result.longitude]).addTo(map);
				marker.bindPopup('<a href="/facilities/'+ result.id + '">'+ result.name +'</a>');
			}
		});

		map.on('moveend', function(){
			var center = map.getCenter();
			current_lat = center.lat;
			current_long = center.lng;
			console.log(current_lat);
			console.log(current_long);

			var low_lat = (current_lat - 0.15);
			console.log(low_lat);
			var high_lat = (current_lat + 0.15);
			console.log(high_lat);
			var low_long = (current_long - 0.15);
			var high_long = (current_long + 0.15);

		$.each(results, function(i, result){
			if (low_lat < result.latitude && result.latitude < high_lat && low_long < result.longitude && result.longitude < high_long) {
			// if (result.latitude < 6 && result.latitude > 5 && result.longitude > -0.7 && result.longitude < 0.3) {
				var marker = L.marker([result.latitude, result.longitude]).addTo(map);
				marker.bindPopup('<a href="/facilities/'+ result.id + '">'+ result.name +'</a>');
			}
		});

		});

	});
		});

	</script>

</body>
</html>
